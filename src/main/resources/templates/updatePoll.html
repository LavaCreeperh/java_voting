<!DOCTYPE html>
<html>
<head>
    <title>Edit Poll</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>
<body>

<div class="container">
    <h2 class="mt-5" id="pollTitle"></h2>
    <input type="text" id="editPollTitle" class="form-control mb-3" placeholder="Edit Poll Title">
    <div id="choicesList" class="mt-4"></div>
    <input type="text" id="newChoice" class="form-control my-3" placeholder="Add New Choice">
    <button class="btn btn-primary" onclick="addChoice()">Add Choice</button>
    <button class="btn btn-success" onclick="updatePoll()">Update Poll</button>
</div>

<script>
    function getPollIdFromUrl() {
        var urlParts = window.location.pathname.split('/');
        return urlParts[urlParts.length - 1];
    }

    var pollId = getPollIdFromUrl(); // Fetch poll ID from URL
    var pollData = {choices: []};

    document.addEventListener('DOMContentLoaded', function () {
        fetchPollData();
    });

    function fetchPollData() {
        fetch('/api/getPoll/' + pollId)
            .then(response => response.json())
            .then(data => {
                displayPollData(data);
            })
            .catch(error => console.error('Error:', error));
    }

    function displayPollData(data) {
        $('#pollTitle').text(data.polls.question);
        $('#editPollTitle').val(data.polls.question);
        pollData.polls = data.polls;
        pollData.choices = data.choices;

        var choicesList = $('#choicesList');
        choicesList.empty();

        if (data.choices.length > 0) {
            data.choices.forEach(function (choice, index) {
                choicesList.append(`
                <div class="input-group mb-2">
                    <input type="text" class="form-control" value="${choice.description}" onchange="editChoice(${index}, this.value)">
                    <div class="input-group-append">
                        <button class="btn btn-danger" onclick="deleteChoice(${index})">Delete</button>
                    </div>
                </div>
            `);
            });
        }
    }

    function editChoice(index, value) {
        pollData.choices[index].description = value;
    }

    function addChoice() {
        var newChoice = $('#newChoice').val();
        if (newChoice) {
            pollData.choices.push({description: newChoice});
            $('#newChoice').val('');
            displayPollData(pollData);
        }
    }

    function deleteChoice(index) {
        var choiceId = pollData.choices[index].id;
        var confirmation = confirm("Are you sure you want to delete this choice?");

        if (confirmation) {
            $.ajax({
                url: '/api/deleteChoice/' + choiceId,
                type: 'GET',
                success: function (response) {
                    // Handle success response
                    if (response.success) {
                        alert("Choice deleted successfully");
                        pollData.choices.splice(index, 1);
                        displayPollData(pollData);
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    // Handle error response
                    alert("An error occurred: " + error);
                }
            });
        }
    }


    function updatePoll() {
        var updatedPollData = {
            polls: {
                id: pollData.polls.id,
                question: $('#editPollTitle').val()
            },
            choices: []
        };

        $('#choicesList').find('.input-group').each(function (index) {
            var choiceInput = $(this).find('input[type="text"]');
            var choice = {
                id: pollData.choices[index] ? pollData.choices[index].id : null,
                description: choiceInput.val()
            };
            updatedPollData.choices.push(choice);
        });

        var newChoiceDescription = $('#newChoice').val();
        if (newChoiceDescription) {
            updatedPollData.choices.push({description: newChoiceDescription, id: null});
        }

        // Send update request to server
        fetch('/api/updatePoll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedPollData)
        })
            .then(response => {
                if (response.ok) {
                    alert('Poll updated successfully');
                    fetchPollData(); // Reload poll data
                } else {
                    alert('Error updating poll');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating poll');
            });
    }

</script>
</body>
</html>
